<VirtualHost *:80>
        ServerName www.fluffbase.local
        ServerAdmin hi@fluffbase.com

        ErrorLog /var/www/error.log
        CustomLog /var/www/access.log combined
        DirectorySlash Off

        RewriteEngine On
        LogLevel alert rewrite:trace8

        DocumentRoot /var/www/public
        
        DirectoryIndex index.js index.html

        RewriteCond %{REQUEST_URI} ^/~.+$
        RewriteRule ^ - [L]

        RewriteCond %{REQUEST_URI} ^/(app|lib|pkg)/?([^/]+)(.*?)(/?)$
        RewriteRule ^ - [S=1,E=TYP:%1,E=NAME:%2,E=URI:%3,E=BASE:/home/%2/public]

        RewriteCond %{REQUEST_URI} ^/(app|lib|pkg)
        RewriteRule ^ - [E=TYP:%1]

        RewriteCond %{ENV:TYP} ^$
        RewriteRule ^ - [L]

        RewriteCond %{ENV:NAME} ^$ [OR]
        RewriteCond %{ENV:NAME} =index.js
        RewriteRule ^ /index.js.cgi?type=%{ENV:TYP} [L]

        RewriteCond %{ENV:BASE}/%{ENV:TYP} -d
        RewriteRule ^ - [S=1,E=LOCAL_PATH:%{ENV:BASE}/%{ENV:TYP}%{ENV:URI},E=URL:/~%{ENV:NAME}/%{ENV:TYP}%{ENV:URI}]

        RewriteCond %{ENV:BASE} -d
        RewriteRule ^ - [E=LOCAL_PATH:%{ENV:BASE}%{ENV:URI},E=URL:/~%{ENV:NAME}%{ENV:URI}]

        RewriteCond %{ENV:LOCAL_PATH} -f
        RewriteRule ^ %{ENV:URL} [PT]

        RewriteCond %{ENV:LOCAL_PATH} -d
        RewriteRule ^ %{ENV:URL}/ [PT]

        <directory /home/*/public>
                AllowOverride All
                Allow from all
                Require all granted
        </directory>

        <directory /var/www/go/bin>
                SetHandler cgi-script
                Allow from all
                Require all granted
        </directory>
        
        <directory /var/www/public>
                Allow from all
                Require all granted
                AllowOverride All
        </directory>
</VirtualHost>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
